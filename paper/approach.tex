\section{Relationship Prediction Approach}

Given a dynamic heterogeneous information network graph $G=(V,E)$, and number of graph snapshots $t$, we first decompose $G$ to a sequence of $t$ heterogeneous graphs ${G_1, .., G_t}$ with respect to its associated timestamps. We then apply our techniques to predict $G_{t+1}$. As mentioned in Definition \ref{problemdef}, in this work we intend to predict \textit{existence of a given type of relationship} (target relation) between two nodes in a heterogeneous network. Therefore we define a new type of graph, called \textit{augmented reduced graph}, that is generated based on a given heterogeneous graph and a target relation meta path. 

\begin{definition}[Augmented reduced graph]\label{def:ARG}
Given a heterogeneous graph $G=(V,E)$ and a target relation meta path $P(a,b)$ between nodes of type $a$ and $b$, an \textit{augmented reduced graph} $G^P=(V^P,E^P)$ is a graph, where $V^P \subseteq V$ and nodes in $V^P$ are of type $a$ and $b$, and edges in $E^P$ indicates relationships of type $P$ in $G$. $\Box$
\end{definition}

\begin{example}
An augmented reduced graph for the network in Figure \ref{sampleNetwork} and target relation meta path $P(Author,Author)$=\textit{A--P--V--P--A} is graph, where nodes are of type \textit{Author} and edges represent relationship of \textit{publishing in the same venue}. For example (\textit{Max}, \textit{Ada}) is an edge in the corresponding augmented reduced graph because they both published at KDD and ICDM. If we consider another meta path $P(Author,Author)$=\textit{A--P--A}, the augmented reduced graph represents a co-authorship graph, where nodes are of type \textit{Author} and edges, such as (\textit{Max}, \textit{Tom}), represent \textit{co-authorship} relationship.  $\Box$

\end{example}


%\subsection{Algorithm}

\subsection{Homogenize link prediction}
% We refer to this approach as \texttt{HomoTemp}.

Zhu et al. \cite{Zhu2016} studied the problem of temporal link prediction in the context of homogeneous networks, where the input is a sequence of graphs $G_1, ..., G_t$ and the output is the estimated $G_{t+1}$. The authors presented a matrix factorization with block-coordinate gradient descent (BCGD) technique that for each $G_\tau$ at time $\tau$ infers a low rank $k$-dimensional latent space representation matrix $Z_\tau$ that minimizes the quadratic loss with temporal regularization
\begin{equation}\label{latentOrigEqu}
    \begin{array}{l}
\argmin\limits_{Z_1, .., Z_t}\sum\limits_{\tau=1}^{t}\left \| G_\tau-Z_{\tau}Z_{\tau}^T \right \|^2_F+\lambda \sum\limits_{\tau=1}^{t}\sum\limits_{u}(1-Z_{\tau}(u)Z_{\tau-1}(u)^T) 
\\
\text{subject to :} \forall u,\tau,Z_{\tau}\geq 0, Z_{\tau}(u)Z_{\tau}(u)^T=1
    \end{array}
\end{equation}
where $\lambda$ is a regularization parameter, and  $(1-Z_{\tau}(u)Z_{\tau-1}(u)^T)$ penalizes node $u$ for suddenly changing its latent position. %Note that when computing the quadratic loss $\left \| G^R_\tau-Z_{\tau}BZ_{\tau}^T \right \|^2_F$, we ignore all of the diagonal entries.
$Z_\tau(u)$ is a row vector denoting $u$'s temporal latent space representation at time $\tau$, and $Z_\tau(u,c)$ indicates the position of $u$ in the $c$-th dimension at $Z$. The intuition behind their prediction model is that 1) nodes move smoothly in the latent space over time and it is less likely to have large moves \cite{sarkar2005dynamic,zhang2014inferring}, and 2) user interactions are more likely to occur between similar users in a latent space representation. Thus it needs $Z_{t+1}$ to predict the future graph $G_{t+1}$. They assume $Z_{t+1}$ can be approximated by $Z_1, ..., Z_t$. Finally they use $Z_tZ_t^T$ to predict $G_{t+1}$. \amin{However, the authors mentioned that the predicted graph at t + 1 can be formulated as Phi(f($Z_1,...Z_t$)), where Phi is the link function and f is the temporal function. Learning or selecting the best link function Phi and temporal function f is beyond the scope of this work. For example, we could apply nonparametric approaches [25] to automatically learn the link function F.}

An immediate adaptation of the above BCGD technique is to consider a sequence of augmented reduced graphs $G^P_i$ as input, i.e., graphs with source and destination of a target relationship type with edges between them if the target relation exists in the original graph. This changes equation (\ref{latentOrigEqu}) to the following
\begin{equation}\label{latentReducedEqu}
    \begin{array}{l}
\argmin\limits_{Z_1, .., Z_t}\sum\limits_{\tau=1}^{t}\left \| G^{P}_\tau-Z_{\tau}Z_{\tau}^T \right \|^2_F+\lambda \sum\limits_{\tau=1}^{t}\sum\limits_{u}(1-Z_{\tau}(u)Z_{\tau-1}(u)^T) 
\\
\text{subject to :} \forall u,\tau,Z_{\tau}\geq 0, Z_{\tau}(u)Z_{\tau}(u)^T=1
    \end{array}
\end{equation}

%Their BCGD technique \cite{Zhu2016} to infer $Z_t$ and estimate $G_{t+1}^R$. We refer to this approach as \texttt{HomoTemp}.


Algorithm \ref{alg1} gets as an input a dynamic heterogeneous graph $G$, number of graph snapshots $t$, a target relation meta path $P(a,b)$, and latent space dimension $k$. The algorithm first decomposes $G$ into a sequence of graphs $\{G_1, .., G_t\}$ (line 1) by considering the associated timestamps on edges. Next from each graph snapshot $G_i$, a corresponding augmented reduced graph $G^P_i$ is generated (lines 2-8) for which nodes are of type $a$ and $b$ (beginning and end of target relation meta path $P$). Finally the BCGD technique in \cite{Zhu2016} is applied (lines 9-10) to infer $k$-dimensional temporal latent spaces $Z_1, ...,Z_t$ and estimate $G^P_{t+1}$ by $Z_tZ_t^T$.
\amin{How $Z_{t+1}$ depends on $Z_1, ..., Z_t$ from the algorithm? Explain assumptions in \cite{Zhu2016}.}


\begin{algorithm}[t]
\caption{Homogenize Link Prediction}\label{alg1}
\begin{algorithmic}[1]
\REQUIRE A dynamic heterogeneous graph $G$, number of graph snapshots $t$, a target relation meta path $P(a,b)$, latent space dimension $k$
\ENSURE The predicted graph $G^P$ at time $t+1$ based on the given target relation meta path $P$

\STATE $\{G_1, .., G_t\} \leftarrow DecomposeGraph(G, t)$

\FOR {each graph $G_i$}
    %\STATE $G^R_i \leftarrow AugmentedReducedGraph(G_i,P,S)$
    \STATE Let $a$ and $b$ be the node types of beginning and end of $P$
    
    %\FOR {each path $p$ between nodes of type $a$ and $b$ in $S$}
    \FOR {each node $x \in V_i$ of type $a$ in $G_i$}
        \STATE follow $P$ to reach a node $y$ of type $b$ in $G_i$ 
        \STATE add edge $(x,y)$ to augmented reduced graph $G_i^P$ 
\ENDFOR

\ENDFOR
%\STATE $G^R_{t+1} \leftarrow BCGD(G^R,k)$ \cite{Zhu2016}
\STATE Infer temporal latent spaces $Z_1, .., Z_t$ by optimizing Eq. \ref{latentReducedEqu}

\STATE $G^P_{t+1} \leftarrow Z_tZ^T_t$ 

\STATE return $G^P_{t+1}$
\end{algorithmic}
\end{algorithm}



\subsection{Meta path-based prediction}

The homogenize approach, however, does not consider different semantics of meta paths between two nodes. Thus we use the idea of meta path \cite{sun2011pathsim} on a given network schema and a target relation type $P$, such as co-authorship, to generate an augmented reduced graph (Definition \ref{def:ARG}) $G^P_i$ from $G_i$ based on $P$.  We then leverage the technique in \cite{Zhu2016} to predict $G^P_{t+1}$ given $G^P_1, ..., G^P_t$, by inferring the temporal latent space representation for nodes at time $t+1$.

Algorithm \ref{alg2} gets as an input a dynamic heterogeneous graph $G$, number of graph snapshots $t$, a network schema $S$, target relation meta path $P(a,b)$ between node types $a$ and $b$, maximum length of a meta path $l$, and latent space dimension $k$. Same as Algorithm \ref{alg1}, it decomposes $G$ into a sequence of graphs (line 1). It then produces the set of all meta paths between a node type $a$ and type $b$ defined in the given target relation $P(a,b)$ (line 2). This is done by traversing the network schema $S$ (for instance a BFS traversal) and generating meta paths with maximum length of $l$ .

\begin{algorithm}[t]
\caption{Meta path-based Link Prediction}\label{alg2}
\begin{algorithmic}[1]
\REQUIRE A dynamic heterogeneous graph $G$, number of graph snapshots $t$, network schema $S$, a target relation meta path $P^*(a,b)$, maximum length of a meta path $l$, latent space dimension $k$
\ENSURE The predicted graph $G^{P^*}$ at time $t+1$ based on the given target relation $P^*$

\STATE $\{G_1, .., G_t\} \leftarrow DecomposeGraph(G, t)$

\STATE $\{P_1, .., P_n\} \leftarrow GenerateMetaPaths(S, P^*(a,b), l)$

\FOR {each meta path $P_j(a,b)$}

\FOR {each graph $G_i$}
    %\STATE $G^R_i \leftarrow AugmentedReducedGraph(G_i,R,S)$
    %\STATE Let $a$ and $b$ be the node types of beginning and end of $P_j$
    
    %\FOR {each path $p$ between nodes of type $a$ and $b$ in $S$}
    \FOR {each node $x \in V_i$ of type $a$ in $G_i$}
        \STATE follow $P_j$ to reach a node $y$ of type $b$ in $G_i$ 
        \STATE $w_{xy} \leftarrow MeasureSimilarity(x,y, G_i)$
        \STATE add edge $(x,y)$ with weight $w_{xy}$ to augmented reduced graph $G_i^{P_j}$ 
\ENDFOR

\ENDFOR

%\STATE $G^R_{t+1} \leftarrow BCGD(G^R,k)$ \cite{Zhu2016}
\STATE Infer temporal latent spaces $Z_1, .., Z_t$ by optimizing Eq. \ref{latentReducedEqu}
\STATE $G^{P_j}_{t+1} \leftarrow Z_tZ^T_t$ 

\ENDFOR

\STATE $G^{P^*}_{t} \leftarrow LastKnownTargetGraph(G, P^*(a,b), t)$


\STATE $\forall (a,b\in N(a)) \in G^{P^*}_{t}$, add a feature vector to the training set with $w_{ab}$ in $G^{P_j}_{t-1}$ for each meta paths $P_j$, and label with 1 if $(a,b) \in E^{P^*}_{t}$ otherwise 0.

\STATE Learn the model and apply it to the feature vector of $G^{P_j}_{t+1}$ with different meta path $P_j$.

\STATE Build $G^{P^*}_{t+1}$ based on the cut-off values for the output of prediction model.

\STATE return $G^{P^*}_{t+1}$
\end{algorithmic}
\end{algorithm}


 Next from each graph snapshot $G_i$, a corresponding augmented reduced graph $G^P_i$ is generated (lines 3-9) for which nodes are of type $a$ and $b$ (beginning and end of meta path $P$) and edges have weight between 0 and 1, based on a similarity measure. For example \textit{PathSim} \cite{sun2011pathsim}, path count, or random walk are measures for the relation of two nodes given link type and meta path, such as co-authorship.

\amin{Note that values of $G^P_i$ depends on meta-path $P$}.

Once the sequence of augmented reduced graphs \{$G^P_1, ..., G^P_t$\} are generated, we apply the matrix factorization with the BCGD technique \cite{Zhu2016} to find a low rank $k$-dimensional latent space representation matrix $Z_\tau$ for nodes at time $\tau$.

% \begin{equation}\label{latentEqu}
%     \begin{array}{l}
% \argmin\limits_{Z_1, .., Z_t}\sum\limits_{\tau=1}^{t}\left \| G^{R_i}_\tau-Z_{\tau}Z_{\tau}^T \right \|^2_F+\lambda \sum\limits_{\tau=1}^{t}\sum\limits_{u}(1-Z_{\tau}(u)Z_{\tau-1}(u)^T) 
% \\
% \text{subject to :} \forall u,\tau,Z_{\tau}\geq 0, Z_{\tau}(u)Z_{\tau}(u)^T=1
%     \end{array}
% \end{equation}




%* Restrict pathSim to 3-hops and not beyond

\head{Learning meta path weights}. Zhu at al. \cite{Zhu2016} assume that the probability of a link between nodes depends only on their latent positions. However, we also consider meta path-based features in our prediction model. Our intuition is that leveraging meta path-based features helps to boost prediction accuracy besides using latent space feature space. In other word, we combine latent space features with parameters indicating importance of the corresponding meta path.

Given the training pairs of nodes and their corresponding meta path-based features (similarity weights $w$), we build a prediction model to learn the weights associated with these features. To do so, we use logistic regression as the prediction model. we can define the probability of existence of a link between nodes $a$ and $b$ as 
\begin{equation*}
Pr(label = 1|a, b; \boldsymbol{\theta}) = \frac{e^{z}}{e^{z}+1}
\end{equation*}
where $z=\sum\limits_{i=1}^{n}\theta_i.w_i$ for $n$ meta paths, $\theta_i$ is a normalized weight value for weight $w_i$ (meta path-based feature) indicating its importance for prediction. In order to learn the prediction model, we use
logistic regression with $L_2$ regularization to estimate the optimal $\theta$. \begin{equation*}
\boldsymbol{\hat{\theta}} = 
\operatorname*{arg\,max}_{\boldsymbol{\theta}}\sum_i log Pr(y_i = 1|a_i, b_i; \boldsymbol{\theta}) - \alpha \sum_{j=1}^N \theta_j^2
\end{equation*}

We derive \textbf{$\hat{\theta}$} which maximizes the likelihood of all the training pairs, using maximum likelihood estimation.


\textbf{Training:} For each pair of nodes $(a,b)$ in $G^{P^*}_{t}$, where $b \in N(a)$ add a feature vector to the training set with corresponding $w_{ab}$ in $G^{P_j}_{t-1}$ for each meta paths $P_j$, and with label 1 if $(a,b) \in E^{P^*}_{t}$ otherwise label 0.

\textbf{Testing:} Perform logestic regression to learn the model. Apply the model to the feature vector of predicted graphs $G^{P_j}_{t+1}$ with different meta path $P_j$. Finally it builds $G^{P^*}_{t+1}$ based on the cut-off values for the output of prediction model.


\subsection{Implementation}

We use the implementation\footnote{\url{https://github.com/linhongseba/Temporal-Network-Embedding}} of temporal latent space inference for a sequence of dynamic graph snapshots \cite{Zhu2016}.






% \begin{algorithm}[h]
% \caption{Generate Predicted Graph}\label{alg1}
% \begin{algorithmic}[1]
% \REQUIRE A dynamic heterogeneous graph $G$, number of graph snapshots $t$, network schema $S$, target relation $R(a,b)$ between nodes of type $a$ and $b$, maximum length of a meta path $l$, latent space dimension $k$
% \ENSURE The predicted graph $G^R$ at time $t+1$ based on the given target relation $R$

% \STATE $\{G_1, .., G_t\} \leftarrow DecomposeGraph(G, t)$

% \STATE $\{P_1, .., P_n\} \leftarrow GenerateMetaPaths(S,R,l)$

% \FOR {each heterogeneous graph $G_i$}
%     %\STATE $G^R_i \leftarrow AugmentedReducedGraph(G_i,R,S)$
    
%     \FOR {each path $p$ between nodes of type $a$ and $b$ in $S$}
%     \FOR {each node $i$ of type $a$ in $G$}
%         \STATE follow $p$ to reach a node $j$ of type $b$ in $G$ 
%         \STATE $w_{ij} \leftarrow PathSim(i,j)$
%         \STATE add edge $(i,j)$ to graph $G^R$ with weight $w_{ij}$
%     \ENDFOR
% \ENDFOR

    
% \ENDFOR
% %\STATE $G^R_{t+1} \leftarrow BCGD(G^R,k)$ \cite{Zhu2016}
% \STATE Infer temporal latent spaces $Z_1, .., Z_t$ by optimizing Eq. \ref{latentEqu}

% \STATE $G^R_{t+1} \leftarrow Z_tZ^T_t$ 

% \STATE return $G^R_{t+1}$
% \end{algorithmic}
% \end{algorithm}


%The process of creating an augmented reduced graph is presented in Algorithm \ref{alg2}.

% \begin{algorithm}[h]
% \caption{Generate augmented reduced graph}\label{alg2}
% \begin{algorithmic}[1]
% \REQUIRE A heterogeneous graph $G$, target relation $R(a,b)$ between nodes of type $a$ and $b$, network schema $S$
% \ENSURE An augmented reduced graph $G^R$ based on the given target relation $R$

% \FOR {each path $p$ between nodes of type $a$ and $b$ in $S$}
%     \FOR {each node $i$ of type $a$ in $G$}
%         \STATE follow $p$ to reach a node $j$ of type $b$ in $G$ 
%         \STATE $w_{ij} \leftarrow PathSim(i,j)$
%         \STATE add edge $(i,j)$ to graph $G^R$ with weight $w_{ij}$
%     \ENDFOR
% \ENDFOR

% \STATE return $G^R$
% \end{algorithmic}
% \end{algorithm}